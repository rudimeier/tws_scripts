#!/bin/bash
export LANG="C"

MAIL_SUBJECT="TWS download"
# set up email address if you want to be informed about updates
FROM_ADDRESS=""
TO_ADDRESS=""

DOWNLOAD_DIR="/var/lib/software/commercial/IB/TWS"
FILES_TO_MIRROR="unixmacosx.jar unixmacosx_latest.jar"
URL_MIRROR="http://download2.interactivebrokers.com/download"

get_perm_file_name()
{
	local ver;
	local dst;
	ver="$(tws_get_version "$1" || date -r "$1" +"unknown%Y%m%d%H%M%S")"
	dst="$(echo "$1" | sed -e "s/\(.*\)\.\(.*\)/\1-${ver}.\2/g" -e 's/_latest//g')"
	echo "${dst}"
}

if ! test -d "${DOWNLOAD_DIR}" ;then
	echo "error: "${DOWNLOAD_DIR}" does not exist" 1>&2
	exit 1
fi

TDIR="$(mktemp -d -t twsdl.XXXX)" || exit 1
trap "rm -rf ${TDIR}" exit
cd "${TDIR}" || exit 1

for FILE_MIRROR in $FILES_TO_MIRROR; do
	FILE_CUR="${DOWNLOAD_DIR}/${FILE_MIRROR}"

	# create fake sparse file for wget because wget -K is broken and -O file
	# conflicts with -N
	if test -f "${FILE_CUR}" ; then
		truncate -r "${FILE_CUR}" "${FILE_MIRROR}"
		touch -r "${FILE_CUR}" "${FILE_MIRROR}"
	fi

	if wget --no-verbose -U "Mozilla/5.0" -N -P "${TDIR}" "${URL_MIRROR}/${FILE_MIRROR}" ;then 
		if test "${FILE_MIRROR}" -nt "${FILE_CUR}" ; then
			DST="$(get_perm_file_name "${FILE_MIRROR}")"
			mv "${FILE_MIRROR}" "${DOWNLOAD_DIR}/${DST}"
			ln -sf "${DST}" "${FILE_CUR}"
			WARN=1
			MAIL_SUBJECT="${MAIL_SUBJECT}, updated ${DST}"
			echo "${FILE_MIRROR} updated to ${DST}" 1>&2
		else
			echo "${FILE_MIRROR} was uptodate" 1>&2
		fi
	else
		echo "check for ${FILE_MIRROR} update failed" 1>&2
		WARN=1;
		MAIL_SUBJECT="${MAIL_SUBJECT}, check ${FILE_MIRROR} failed"
	fi
done

if test -n "$WARN" && test -n "$TO_ADDRESS"; then
	echo "send mail: $MAIL_SUBJECT" 1>&2
	ls -l "${DOWNLOAD_DIR}" \
		| mailx -s "$MAIL_SUBJECT" -r $FROM_ADDRESS $TO_ADDRESS
fi


